<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Embedding Visualization</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body class="visualization">
    <div id="info">Click a point to see document info</div>
    <div id="stats"></div>
    <div id="loading">
        <div>Loading visualization data...</div>
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
    </div>
    <div class="controls">
        <button id="resetView">Reset View</button>
        <label>
            Point Size:
            <input type="range" id="pointSize" min="0.01" max="0.2" step="0.01" value="0.05">
        </label>
        <label>
            Show Connections:
            <input type="checkbox" id="showConnections" checked>
        </label>
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect"></select>
    </div>
    <script src="/static/js/oboe-browser.min.js"></script>
    <script type="module">
        import { initVisualization } from '/static/js/embedding-viz.js';

        const modelSelect = document.getElementById('modelSelect');
        let currentModel = '';

        async function fetchModels() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    currentModel = data.models[0]; // Select the first model by default
                    modelSelect.value = currentModel;
                    loadVisualizationForModel(currentModel);
                } else {
                    document.getElementById('loading').innerHTML = '<div>No models found. Please export data from the workstation.</div>';
                }
            } catch (error) {
                console.error('Failed to fetch models:', error);
                document.getElementById('loading').innerHTML = '<div>Error loading models. Check console.</div>';
            }
        }

        async function loadVisualizationForModel(modelName) {
            if (!modelName) return;
            const dataUrl = `/api/visualization_data/${modelName}`;
            // Pass the dataUrl and other necessary elements to the existing initVisualization
            // Assuming initVisualization can take a URL or can be modified to do so.
            // You might need to adjust how initVisualization in embedding-viz.js gets its data.
            // For now, we'll call it, assuming it knows how to fetch from a global or passed URL.
            // This part might require refactoring embedding-viz.js to accept a data URL.
            console.log(`Loading visualization for model: ${modelName} from ${dataUrl}`);
            initVisualization(dataUrl); // You'll need to adapt embedding-viz.js
        }

        modelSelect.addEventListener('change', (event) => {
            currentModel = event.target.value;
            loadVisualizationForModel(currentModel);
        });

        // Initial load
        fetchModels();
    </script>
</body>

</html>